============================= test session starts =============================
platform win32 -- Python 3.13.3, pytest-9.0.2, pluggy-1.6.0 -- E:\Coding\Manipal Dot Net\EcommerceFresh\venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: E:\Coding\Manipal Dot Net\EcommerceFresh
plugins: anyio-4.12.1
collecting ... collected 10 items

tests/test_main.py::test_health_check PASSED                             [ 10%]
tests/test_main.py::test_register_user PASSED                            [ 20%]
tests/test_main.py::test_login_user PASSED                               [ 30%]
tests/test_main.py::test_create_category PASSED                          [ 40%]
tests/test_main.py::test_create_product PASSED                           [ 50%]
tests/test_main.py::test_coupon_flow PASSED                              [ 60%]
tests/test_main.py::test_apply_invalid_coupon PASSED                     [ 70%]
tests/test_main.py::test_reviews_flow PASSED                             [ 80%]
tests/test_main.py::test_checkout_and_orders FAILED                      [ 90%]
tests/test_main.py::test_shipping_calculation PASSED                     [100%]

================================== FAILURES ===================================
__________________________ test_checkout_and_orders ___________________________

db = None

    def test_checkout_and_orders(db):
        token = test_login_user(db)
        headers = {"Authorization": f"Bearer {token}"}
    
        # 0. Checkout Pre-requisite: Clear cart to ensure clean state
        # Previous tests might have left items in cart
        # We can either delete all items or just rely on checkout to clear it?
        # Checkout clears cart. But we found 300 total (expected 200).
        # This means items were present.
        # Let's verify empty cart first or clear it.
        # Since we don't have a clear-cart endpoint exposed in test client easily (DELETE /cart/ is implemented?)
        # app/routers/cart.py has DELETE / (clear_cart).
        client.delete("/cart/", headers=headers)
    
        # 1. Setup: Add to cart
        prod_id = test_create_product(db)
        client.post(
            "/cart/",
            json={"product_id": prod_id, "quantity": 2}, # 2 * 100 = 200
            headers=headers
        )
    
        # 2. Checkout
        response = client.post(
            "/orders/checkout",
            json={
                "shipping_address": "123 Test St",
                "coupon_code": None
            },
            headers=headers
        )
        assert response.status_code == 201
        order_data = response.json()
>       assert order_data["total_amount"] == 200.0
E       assert 300.0 == 200.0

tests\test_main.py:225: AssertionError
------------------------------ Captured log call ------------------------------
INFO     ecommerce:middleware.py:44 {"user_id": null, "method": "POST", "path": "/auth/login", "status_code": 200, "process_time": "0.199s", "timestamp": "2026-01-14 23:11:41"}
INFO     ecommerce:middleware.py:44 {"user_id": "1", "method": "DELETE", "path": "/cart/", "status_code": 422, "process_time": "0.003s", "timestamp": "2026-01-14 23:11:41"}
INFO     ecommerce:middleware.py:44 {"user_id": null, "method": "POST", "path": "/categories/", "status_code": 400, "process_time": "0.002s", "timestamp": "2026-01-14 23:11:41"}
INFO     ecommerce:middleware.py:44 {"user_id": null, "method": "GET", "path": "/categories/", "status_code": 200, "process_time": "0.002s", "timestamp": "2026-01-14 23:11:41"}
INFO     ecommerce:middleware.py:44 {"user_id": null, "method": "POST", "path": "/products/", "status_code": 201, "process_time": "0.003s", "timestamp": "2026-01-14 23:11:41"}
INFO     ecommerce:middleware.py:44 {"user_id": "1", "method": "POST", "path": "/cart/", "status_code": 201, "process_time": "0.005s", "timestamp": "2026-01-14 23:11:41"}
INFO     ecommerce:middleware.py:44 {"user_id": "1", "method": "POST", "path": "/orders/checkout", "status_code": 201, "process_time": "0.012s", "timestamp": "2026-01-14 23:11:41"}
============================== warnings summary ===============================
app\database.py:8
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\database.py:8: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Base = declarative_base()

app\schemas.py:16
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\schemas.py:16: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class UserResponse(BaseModel):

app\schemas.py:35
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\schemas.py:35: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class CategoryResponse(BaseModel):

app\schemas.py:61
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\schemas.py:61: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ProductResponse(BaseModel):

app\schemas.py:83
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\schemas.py:83: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class CartItemResponse(BaseModel):

app\schemas.py:111
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\schemas.py:111: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ReviewResponse(BaseModel):

app\schemas.py:123
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\schemas.py:123: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class OrderItemResponse(BaseModel):

app\schemas.py:143
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\schemas.py:143: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class OrderResponse(BaseModel):

app\schemas.py:166
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\schemas.py:166: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class CouponResponse(BaseModel):

tests/test_main.py: 21 warnings
  E:\Coding\Manipal Dot Net\EcommerceFresh\venv\Lib\site-packages\sqlalchemy\sql\schema.py:3624: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return util.wrap_callable(lambda ctx: fn(), fn)  # type: ignore

tests/test_main.py::test_register_user
tests/test_main.py::test_login_user
tests/test_main.py::test_create_category
tests/test_main.py::test_coupon_flow
tests/test_main.py::test_apply_invalid_coupon
tests/test_main.py::test_reviews_flow
tests/test_main.py::test_checkout_and_orders
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\utils.py:22: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    expire = datetime.utcnow() + expires_delta

tests/test_main.py::test_register_user
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\routers\auth.py:49: PydanticDeprecatedSince20: The `from_orm` method is deprecated; set `model_config['from_attributes']=True` and use `model_validate` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    "user": UserResponse.from_orm(db_user)

tests/test_main.py::test_login_user
tests/test_main.py::test_create_category
tests/test_main.py::test_coupon_flow
tests/test_main.py::test_apply_invalid_coupon
tests/test_main.py::test_reviews_flow
tests/test_main.py::test_checkout_and_orders
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\routers\auth.py:74: PydanticDeprecatedSince20: The `from_orm` method is deprecated; set `model_config['from_attributes']=True` and use `model_validate` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    "user": UserResponse.from_orm(user)

tests/test_main.py::test_login_user
  E:\Coding\Manipal Dot Net\EcommerceFresh\venv\Lib\site-packages\_pytest\python.py:170: PytestReturnNotNoneWarning: Test functions should return None, but tests/test_main.py::test_login_user returned <class 'str'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

tests/test_main.py::test_create_product
  E:\Coding\Manipal Dot Net\EcommerceFresh\venv\Lib\site-packages\_pytest\python.py:170: PytestReturnNotNoneWarning: Test functions should return None, but tests/test_main.py::test_create_product returned <class 'int'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_main.py::test_checkout_and_orders - assert 300.0 == 200.0
================== 1 failed, 9 passed, 46 warnings in 2.81s ===================
