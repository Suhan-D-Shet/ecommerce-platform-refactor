============================= test session starts =============================
platform win32 -- Python 3.13.3, pytest-9.0.2, pluggy-1.6.0 -- E:\Coding\Manipal Dot Net\EcommerceFresh\venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: E:\Coding\Manipal Dot Net\EcommerceFresh
plugins: anyio-4.12.1
collecting ... collected 10 items

tests/test_main.py::test_health_check PASSED                             [ 10%]
tests/test_main.py::test_register_user FAILED                            [ 20%]
tests/test_main.py::test_login_user FAILED                               [ 30%]
tests/test_main.py::test_create_category FAILED                          [ 40%]
tests/test_main.py::test_create_product PASSED                           [ 50%]
tests/test_main.py::test_coupon_flow FAILED                              [ 60%]
tests/test_main.py::test_apply_invalid_coupon FAILED                     [ 70%]
tests/test_main.py::test_reviews_flow FAILED                             [ 80%]
tests/test_main.py::test_checkout_and_orders FAILED                      [ 90%]
tests/test_main.py::test_shipping_calculation PASSED                     [100%]

================================== FAILURES ===================================
_____________________________ test_register_user ______________________________

db = None

    def test_register_user(db):
>       response = client.post(
            "/auth/register",
            json={
                "email": "test@example.com",
                "username": "testuser",
                "password": "password123"
            }
        )

tests\test_main.py:44: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
venv\Lib\site-packages\starlette\testclient.py:546: in post
    return super().post(
venv\Lib\site-packages\httpx\_client.py:1144: in post
    return self.request(
venv\Lib\site-packages\starlette\testclient.py:445: in request
    return super().request(
venv\Lib\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
venv\Lib\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
venv\Lib\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\starlette\testclient.py:348: in handle_request
    raise exc
venv\Lib\site-packages\starlette\testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
venv\Lib\site-packages\anyio\from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Python313\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
C:\Python313\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
venv\Lib\site-packages\anyio\from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\fastapi\applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
venv\Lib\site-packages\starlette\applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
venv\Lib\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
venv\Lib\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
venv\Lib\site-packages\starlette\middleware\base.py:191: in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ^^^^^^^^^^^^^^^^^^^^
C:\Python313\Lib\contextlib.py:162: in __exit__
    self.gen.throw(value)
venv\Lib\site-packages\starlette\_utils.py:85: in collapse_excgroups
    raise exc
venv\Lib\site-packages\starlette\middleware\base.py:193: in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app\middleware.py:30: in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\starlette\middleware\base.py:168: in call_next
    raise app_exc from app_exc.__cause__ or app_exc.__context__
venv\Lib\site-packages\starlette\middleware\base.py:144: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv\Lib\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
venv\Lib\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
venv\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
venv\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv\Lib\site-packages\fastapi\middleware\asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
venv\Lib\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
venv\Lib\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
venv\Lib\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
venv\Lib\site-packages\fastapi\routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
venv\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
venv\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
venv\Lib\site-packages\fastapi\routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
venv\Lib\site-packages\fastapi\routing.py:355: in app
    raw_response = await run_endpoint_function(
venv\Lib\site-packages\fastapi\routing.py:245: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\starlette\concurrency.py:32: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\anyio\to_thread.py:63: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
venv\Lib\site-packages\anyio\_backends\_asyncio.py:2502: in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
venv\Lib\site-packages\anyio\_backends\_asyncio.py:986: in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
app\routers\auth.py:28: in register
    hashed_password = hash_password(user_data.password)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app\utils.py:11: in hash_password
    return pwd_context.hash(password)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\passlib\context.py:2258: in hash
    return record.hash(secret, **kwds)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\passlib\utils\handlers.py:779: in hash
    self.checksum = self._calc_checksum(secret)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\passlib\handlers\bcrypt.py:591: in _calc_checksum
    self._stub_requires_backend()
venv\Lib\site-packages\passlib\utils\handlers.py:2254: in _stub_requires_backend
    cls.set_backend()
venv\Lib\site-packages\passlib\utils\handlers.py:2156: in set_backend
    return owner.set_backend(name, dryrun=dryrun)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\passlib\utils\handlers.py:2163: in set_backend
    return cls.set_backend(name, dryrun=dryrun)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\passlib\utils\handlers.py:2188: in set_backend
    cls._set_backend(name, dryrun)
venv\Lib\site-packages\passlib\utils\handlers.py:2311: in _set_backend
    super(SubclassBackendMixin, cls)._set_backend(name, dryrun)
venv\Lib\site-packages\passlib\utils\handlers.py:2224: in _set_backend
    ok = loader(**kwds)
         ^^^^^^^^^^^^^^
venv\Lib\site-packages\passlib\handlers\bcrypt.py:626: in _load_backend_mixin
    return mixin_cls._finalize_backend_mixin(name, dryrun)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\passlib\handlers\bcrypt.py:421: in _finalize_backend_mixin
    if detect_wrap_bug(IDENT_2A):
       ^^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\passlib\handlers\bcrypt.py:380: in detect_wrap_bug
    if verify(secret, bug_hash):
       ^^^^^^^^^^^^^^^^^^^^^^^^
venv\Lib\site-packages\passlib\utils\handlers.py:792: in verify
    return consteq(self._calc_checksum(secret), chk)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <passlib.handlers.bcrypt._BcryptBackend object at 0x000001CC9B87AD70>
secret = b'01234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345...7890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234'

    def _calc_checksum(self, secret):
        # bcrypt behavior:
        #   secret must be bytes
        #   config must be ascii bytes
        #   returns ascii bytes
        secret, ident = self._prepare_digest_args(secret)
        config = self._get_config(ident)
        if isinstance(config, unicode):
            config = config.encode("ascii")
>       hash = _bcrypt.hashpw(secret, config)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       ValueError: password cannot be longer than 72 bytes, truncate manually if necessary (e.g. my_password[:72])

venv\Lib\site-packages\passlib\handlers\bcrypt.py:655: ValueError
------------------------------ Captured log call ------------------------------
WARNING  passlib.handlers.bcrypt:bcrypt.py:622 (trapped) error reading bcrypt version
Traceback (most recent call last):
  File "E:\Coding\Manipal Dot Net\EcommerceFresh\venv\Lib\site-packages\passlib\handlers\bcrypt.py", line 620, in _load_backend_mixin
    version = _bcrypt.__about__.__version__
              ^^^^^^^^^^^^^^^^^
AttributeError: module 'bcrypt' has no attribute '__about__'
_______________________________ test_login_user _______________________________

db = None

    def test_login_user(db):
        response = client.post(
            "/auth/login",
            json={
                "email": "test@example.com",
                "password": "password123"
            }
        )
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401 Unauthorized]>.status_code

tests\test_main.py:65: AssertionError
------------------------------ Captured log call ------------------------------
INFO     ecommerce:middleware.py:44 {"user_id": null, "method": "POST", "path": "/auth/login", "status_code": 401, "process_time": "0.003s", "timestamp": "2026-01-14 23:08:56"}
____________________________ test_create_category _____________________________

db = None

    def test_create_category(db):
>       token = test_login_user(db)
                ^^^^^^^^^^^^^^^^^^^

tests\test_main.py:71: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

db = None

    def test_login_user(db):
        response = client.post(
            "/auth/login",
            json={
                "email": "test@example.com",
                "password": "password123"
            }
        )
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401 Unauthorized]>.status_code

tests\test_main.py:65: AssertionError
------------------------------ Captured log call ------------------------------
INFO     ecommerce:middleware.py:44 {"user_id": null, "method": "POST", "path": "/auth/login", "status_code": 401, "process_time": "0.002s", "timestamp": "2026-01-14 23:08:56"}
______________________________ test_coupon_flow _______________________________

db = None

    def test_coupon_flow(db):
>       token = test_login_user(db)
                ^^^^^^^^^^^^^^^^^^^

tests\test_main.py:112: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

db = None

    def test_login_user(db):
        response = client.post(
            "/auth/login",
            json={
                "email": "test@example.com",
                "password": "password123"
            }
        )
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401 Unauthorized]>.status_code

tests\test_main.py:65: AssertionError
------------------------------ Captured log call ------------------------------
INFO     ecommerce:middleware.py:44 {"user_id": null, "method": "POST", "path": "/auth/login", "status_code": 401, "process_time": "0.002s", "timestamp": "2026-01-14 23:08:56"}
__________________________ test_apply_invalid_coupon __________________________

db = None

    def test_apply_invalid_coupon(db):
>       token = test_login_user(db)
                ^^^^^^^^^^^^^^^^^^^

tests\test_main.py:153: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

db = None

    def test_login_user(db):
        response = client.post(
            "/auth/login",
            json={
                "email": "test@example.com",
                "password": "password123"
            }
        )
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401 Unauthorized]>.status_code

tests\test_main.py:65: AssertionError
------------------------------ Captured log call ------------------------------
INFO     ecommerce:middleware.py:44 {"user_id": null, "method": "POST", "path": "/auth/login", "status_code": 401, "process_time": "0.002s", "timestamp": "2026-01-14 23:08:56"}
______________________________ test_reviews_flow ______________________________

db = None

    def test_reviews_flow(db):
>       token = test_login_user(db)
                ^^^^^^^^^^^^^^^^^^^

tests\test_main.py:170: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

db = None

    def test_login_user(db):
        response = client.post(
            "/auth/login",
            json={
                "email": "test@example.com",
                "password": "password123"
            }
        )
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401 Unauthorized]>.status_code

tests\test_main.py:65: AssertionError
------------------------------ Captured log call ------------------------------
INFO     ecommerce:middleware.py:44 {"user_id": null, "method": "POST", "path": "/auth/login", "status_code": 401, "process_time": "0.006s", "timestamp": "2026-01-14 23:08:56"}
__________________________ test_checkout_and_orders ___________________________

db = None

    def test_checkout_and_orders(db):
>       token = test_login_user(db)
                ^^^^^^^^^^^^^^^^^^^

tests\test_main.py:193: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

db = None

    def test_login_user(db):
        response = client.post(
            "/auth/login",
            json={
                "email": "test@example.com",
                "password": "password123"
            }
        )
>       assert response.status_code == 200
E       assert 401 == 200
E        +  where 401 = <Response [401 Unauthorized]>.status_code

tests\test_main.py:65: AssertionError
------------------------------ Captured log call ------------------------------
INFO     ecommerce:middleware.py:44 {"user_id": null, "method": "POST", "path": "/auth/login", "status_code": 401, "process_time": "0.003s", "timestamp": "2026-01-14 23:08:56"}
============================== warnings summary ===============================
app\database.py:8
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\database.py:8: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Base = declarative_base()

app\schemas.py:16
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\schemas.py:16: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class UserResponse(BaseModel):

app\schemas.py:35
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\schemas.py:35: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class CategoryResponse(BaseModel):

app\schemas.py:61
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\schemas.py:61: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ProductResponse(BaseModel):

app\schemas.py:83
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\schemas.py:83: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class CartItemResponse(BaseModel):

app\schemas.py:111
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\schemas.py:111: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ReviewResponse(BaseModel):

app\schemas.py:123
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\schemas.py:123: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class OrderItemResponse(BaseModel):

app\schemas.py:143
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\schemas.py:143: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class OrderResponse(BaseModel):

app\schemas.py:166
  E:\Coding\Manipal Dot Net\EcommerceFresh\app\schemas.py:166: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class CouponResponse(BaseModel):

tests/test_main.py::test_create_product
tests/test_main.py::test_create_product
tests/test_main.py::test_create_product
  E:\Coding\Manipal Dot Net\EcommerceFresh\venv\Lib\site-packages\sqlalchemy\sql\schema.py:3624: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return util.wrap_callable(lambda ctx: fn(), fn)  # type: ignore

tests/test_main.py::test_create_product
  E:\Coding\Manipal Dot Net\EcommerceFresh\venv\Lib\site-packages\_pytest\python.py:170: PytestReturnNotNoneWarning: Test functions should return None, but tests/test_main.py::test_create_product returned <class 'int'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_main.py::test_register_user - ValueError: password cannot b...
FAILED tests/test_main.py::test_login_user - assert 401 == 200
FAILED tests/test_main.py::test_create_category - assert 401 == 200
FAILED tests/test_main.py::test_coupon_flow - assert 401 == 200
FAILED tests/test_main.py::test_apply_invalid_coupon - assert 401 == 200
FAILED tests/test_main.py::test_reviews_flow - assert 401 == 200
FAILED tests/test_main.py::test_checkout_and_orders - assert 401 == 200
================== 7 failed, 3 passed, 13 warnings in 1.78s ===================
